<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="theme-color" content="#A7B59E" />
    <title>Panel HarujaGdl</title>

    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <style>
      :root {
        --fondo: #ffffff;
        --texto: #383234;
        --acento: #a7b59e;
        --beige: #faf6f1;
        --gris: #6b6b6b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--beige);
        color: var(--texto);
        text-align: center;
      }

      .logo img {
        max-width: 220px;
        margin: 28px auto 5px;
        display: block;
      }

      h1 {
        margin-top: 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--texto);
      }

      /* ===== GRIDS ===== */

      .grid,
      .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 22px;
        padding: 22px;
        max-width: 900px;
        margin: auto;
        text-align: center;
      }

      .admin-grid {
        display: none;
      }

      /* ===== TARJETAS ===== */

      .card,
      .admin-card {
        background: #ffffff;
        padding: 22px 16px 18px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid #f0f0f0;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        height: 300px;
      }

      .card:hover,
      .admin-card:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .card--auto {
        height: auto;
      }

      /* ===== ICONOS REDONDOS ===== */

      .icon-circle,
      .admin-icon-circle {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        margin: 0 auto 12px;
        transition: transform 0.15s ease;
      }

      .card:hover .icon-circle,
      .admin-card:hover .admin-icon-circle {
        transform: scale(1.05);
      }

      .emoji,
      .admin-icon {
        font-size: 34px;
      }

      /* ===== BOTONES ===== */

      .btn,
      .admin-btn {
        margin-top: auto;
        display: inline-block;
        width: 100%;
        background: var(--acento);
        padding: 10px 0;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-size: 14px;
        border: none;
        cursor: pointer;
      }

      .btn:disabled,
      .admin-btn:disabled {
        opacity: 0.7;
        cursor: default;
      }

      /* ===== ADMIN BUTTON / SECCI√ìN ===== */

      .admin-section {
        max-width: 900px;
        margin: 10px auto 0;
        padding: 0 22px;
        text-align: center;
      }

      .admin-trigger {
        background: transparent;
        border: none;
        padding: 8px 0;
        cursor: pointer;
        font-size: 15px;
        color: var(--texto);
        text-decoration: underline;
      }

      /* ===== OVERLAY CARGANDO ===== */

      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(56, 50, 52, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-box {
        background: var(--beige, #faf6f1);
        padding: 16px 20px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        text-align: center;
        min-width: 220px;
      }

      .loading-spinner {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid rgba(167, 181, 158, 0.4);
        border-top-color: var(--acento, #a7b59e);
        margin: 0 auto 10px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ===== TOAST ===== */

      .toast {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: #383234;
        color: #fff;
        padding: 10px 16px;
        border-radius: 999px;
        font-size: 0.9rem;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        z-index: 10000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease, transform 0.25s ease;
      }

      .toast--visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
      }

      .toast--success {
        background: #3a7f4a;
      }

      .toast--error {
        background: #b53737;
      }

      .toast--info {
        background: #383234;
      }

      /* ===== SECCI√ìN MOVIMIENTOS ===== */

      .mov-section {
        max-width: 900px;
        margin: 0 auto 24px;
        padding: 0 22px 22px;
        text-align: left;
        display: none; /* Se muestra al dar clic en el bot√≥n */
      }

      .mov-section h2 {
        font-size: 20px;
        margin-bottom: 10px;
        text-align: left;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 12px;
        width: 100%;
        text-align: left;
        margin-bottom: 8px;
      }

      .form-grid label {
        font-size: 0.85rem;
        color: var(--gris);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .form-grid input,
      .form-grid select,
      .form-grid textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #ddd;
        padding: 6px 8px;
        font-family: inherit;
        font-size: 0.9rem;
      }

      .form-grid textarea {
        resize: vertical;
      }

      .form-grid .full {
        grid-column: 1 / -1;
      }

      #mov-scanner-container {
        margin-top: 10px;
        position: relative;
      }

      #mov-video {
        width: 100%;
        max-height: 260px;
        border-radius: 12px;
        background: #000;
        object-fit: cover;
      }

      #mov-canvas {
        display: none;
      }

      /* Marco de escaneo */
      .scan-frame {
        position: absolute;
        inset: 10%;
        border-radius: 12px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        box-sizing: border-box;
        pointer-events: none;
      }

      #mov-help {
        font-size: 0.85rem;
        color: var(--gris);
        margin-top: 6px;
        text-align: center;
      }

      #mov-tabla-items {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      #mov-tabla-items th,
      #mov-tabla-items td {
        border-bottom: 1px solid #eee;
        padding: 4px 6px;
        text-align: left;
      }

      #mov-tabla-items th {
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--gris);
      }

      #mov-tabla-items td:last-child {
        text-align: center;
      }

      #mov-tabla-items button {
        border: none;
        border-radius: 8px;
        padding: 3px 8px;
        font-size: 0.8rem;
        background: #eee;
        cursor: pointer;
      }

      #mov-mensaje {
        font-size: 0.85rem;
        color: var(--gris);
      }
    </style>
  </head>

  <body>
    <div class="logo">
      <img src="/icons/icon-512.png" alt="HarujaGdl" />
    </div>

    <h1 id="panelTitle">Panel de Herramientas HarujaGdl</h1>

    <!-- PANEL P√öBLICO -->
    <div id="publicGrid" class="grid">
      <div class="card">
        <div class="icon-circle"><span class="emoji">üí∏</span></div>
        <h3>Registro de Venta</h3>
        <p>Registra ventas completas.</p>
        <a class="btn" href="/registro-ventas.html">Ir a app</a>
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üìä</span></div>
        <h3>Base de datos ventas</h3>
        <p>Consulta historial completo.</p>
        <a
          class="btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/1FvUAsQZr8vqh_OOsHsHjHA7RprV_fmuqikm0U_Ja3_M/edit?gid=1077810078#gid=1077810078"
          >Ir a app</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üéÅ</span></div>
        <h3>Plan de Lealtad</h3>
        <p>Puntos y clientes.</p>
        <a class="btn" href="/plan-lealtad.html" target="_blank">Ir a app</a>
      </div>

      <!-- BD sistema de lealtad -->
      <div class="card">
        <div class="icon-circle"><span class="emoji">üìö</span></div>
        <h3>Base de datos plan de lealtad</h3>
        <p>Base de datos plan de lealtad.</p>
        <a
          class="btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/1thDRVw0qmCBfQdNT2-Crv6RrMAzo-AcwNL9q21pODpA/edit?gid=0#gid=0"
          >Ir a app</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üì¶</span></div>
        <h3>Generar Apartados</h3>
        <p>Crea apartados y anticipo.</p>
        <a
          class="btn"
          target="_blank"
          href="https://script.google.com/macros/s/AKfycbz4fkeXmAIj-QbyT8IYRvwiortS4b6vSLj66j_Ph5sdfuczU6ATDRWtY9gY717t7r4i/exec"
          >Ir a app</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üóÇÔ∏è</span></div>
        <h3>Bit√°cora de Apartados</h3>
        <p>Status y seguimiento.</p>
        <a
          class="btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/17168QLgL2RQpAOoJmckQCnKRTjGcQxZ-_wKQeCptQkE/edit?usp=sharing"
          >Ver bit√°cora</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üéüÔ∏è</span></div>
        <h3>Tickets PDF</h3>
        <p>Carpeta de tickets.</p>
        <a
          class="btn"
          target="_blank"
          href="https://drive.google.com/drive/folders/12yvsXrxUYnfr2o0eMx1uBUllkr7to8RK?usp=drive_link"
          >Abrir carpeta</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üßµ</span></div>
        <h3>Registro de Nueva Prenda</h3>
        <p>C√≥digos nuevos.</p>
        <a
          class="btn"
          target="_blank"
          href="https://script.google.com/macros/s/AKfycbx6OThWWitX9xEANDZEZlC4mbW1k0iTvI8HzqPTPjHcYRvqKykxG3fsk2bIE33z9vOV9w/exec"
          >Ir a app</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üí≤</span></div>
        <h3>Asignar Precios</h3>
        <p>Define precios finales.</p>
        <a
          class="btn"
          target="_blank"
          href="https://script.google.com/macros/s/AKfycbxaIZCxNEkIdGcdOU8a5oVqHoIZQ6S9TvhUQBTbhjZfHCczL8zeznFhv35c9AHDApgg/exec"
          >Ir a app</a
        >
      </div>

      <div class="card">
        <div class="icon-circle"><span class="emoji">üßÆ</span></div>
        <h3>Calculadora sobre pedidos</h3>
        <p>Precios estimados.</p>
        <a class="btn" href="/calculadora-pedidos.html">Ir a app</a>
      </div>

      <!-- Movimientos de ropa (bot√≥n) -->
      <div class="card">
        <div class="icon-circle"><span class="emoji">üöö</span></div>
        <h3>Movimientos de ropa</h3>
        <p>Salidas y entradas con esc√°ner.</p>
        <button class="btn" type="button" onclick="abrirMovimientosRopa()">
          Ir a app
        </button>
      </div>
    </div>

    <!-- SECCI√ìN MOVIMIENTOS DE ROPA -->
    <section id="movimientos-ropa" class="mov-section">
      <div class="card card--auto">
        <h2>Movimientos de ropa (salidas / entradas)</h2>

        <div class="form-grid">
          <label>
            Fecha
            <input type="date" id="mov-fecha" />
          </label>

          <label>
            Tipo de movimiento
            <select id="mov-tipo">
              <option value="Salida">Salida</option>
              <option value="Entrada">Entrada</option>
            </select>
          </label>

          <label>
            Responsable
            <input
              type="text"
              id="mov-responsable"
              placeholder="Haru, Yair, Sam..."
            />
          </label>

          <label class="full">
            Comentarios
            <textarea
              id="mov-comentarios"
              rows="2"
              placeholder="Ej. activaci√≥n, sesi√≥n de fotos, etc."
            ></textarea>
          </label>
        </div>

        <hr style="margin: 12px 0" />

        <h3 style="margin: 0 0 8px">Escanear prendas</h3>

        <div
          style="
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
          "
        >
          <button
            id="mov-btn-iniciar-scan"
            class="btn"
            type="button"
            style="margin-top: 0; flex: 1"
          >
            Iniciar esc√°ner
          </button>
          <button
            id="mov-btn-detener-scan"
            class="btn"
            type="button"
            style="margin-top: 0; flex: 1; background: #bbb"
            disabled
          >
            Detener
          </button>
        </div>

        <div id="mov-scanner-container">
          <video id="mov-video"></video>
          <canvas id="mov-canvas"></canvas>
          <div class="scan-frame"></div>
        </div>
        <p id="mov-help">
          Apunta el c√≥digo al recuadro como en la app de esc√°ner üì∑
        </p>

        <h3 style="margin: 14px 0 6px">Prendas escaneadas</h3>

        <div style="max-height: 220px; overflow: auto; margin-bottom: 8px">
          <table id="mov-tabla-items">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Color</th>
                <th>Talla</th>
                <th>Tipo</th>
                <th>Precio</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <button
          id="mov-btn-guardar"
          class="btn"
          type="button"
          style="margin-top: 4px"
        >
          Guardar movimiento
        </button>

        <p id="mov-mensaje"></p>
      </div>
    </section>

    <!-- BOT√ìN ADMIN -->
    <div class="admin-section">
      <button id="adminToggle" class="admin-trigger">üîê Administrador</button>
    </div>

    <!-- PANEL ADMIN -->
    <div id="adminGrid" class="admin-grid">
      <!-- Apartados -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üì¶</span></div>
        <h4>Apartados</h4>
        <p>BD apartados Haruja</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/17168QLgL2RQpAOoJmckQCnKRTjGcQxZ-_wKQeCptQkE/edit?gid=784913066#gid=784913066"
        >
          Ir a app
        </a>
      </div>

      <!-- Est. Precios -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üè∑Ô∏è</span></div>
        <h4>Est. Precios</h4>
        <p>Estimaci√≥n de precios</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://script.google.com/macros/s/AKfycby4NNyRSFmQm-dgXf9dpTqVxBDORBtOnPywiffLNyvotUM66ZKjWCFgyIqAX-kPo_M/exec"
        >
          Ir a app
        </a>
      </div>

      <!-- C√≥digos -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üßæ</span></div>
        <h4>C√≥digos</h4>
        <p>BD creaci√≥n de c√≥digos</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/1DFIZc3BvqRSvaPqhBm1Geu4aeZji6zuIAZKpkeplpwU/edit?usp=sharing"
        >
          Ir a app
        </a>
      </div>

      <!-- Calculadora (BD) -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üì±</span></div>
        <h4>Calculadora (BD)</h4>
        <p>BD calculadora Haruja</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/1hLSh3sqKAi_BC3t6sWhP4Bl0-qlaZbMXhs9tGa0HU2Q/edit?usp=sharing"
        >
          Ir a app
        </a>
      </div>

      <!-- Master -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üìã</span></div>
        <h4>Master</h4>
        <p>BD precios Haruja</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/1S9mZbcQehmyiwaebh0GKlQQF7HDWLTdvJZFkV-vY_ZA/edit?usp=sharing"
        >
          Ir a app
        </a>
      </div>

      <!-- Actualizar Master -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">‚öôÔ∏è</span></div>
        <h4>Actualizar Master</h4>
        <p>Corre: c√≥digos nuevos y precios desde Calculadora.</p>
        <button
          id="btnPipelineMaster"
          class="admin-btn"
          type="button"
          onclick="ejecutarPipelineMaster()"
        >
          Ejecutar actualizaci√≥n
        </button>
      </div>

      <!-- BD Tiendanube -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üìÑ</span></div>
        <h4>BD Tiendanube</h4>
        <p>Base de datos precios</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/1GfXUv-Y143yQJFC-6_kLZH3kT5rid2BLTEFHFKoikyQ/edit?usp=sharing"
        >
          Ir a app
        </a>
      </div>

      <!-- CSV SMP -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üíæ</span></div>
        <h4>CSV SMP</h4>
        <p>BD tickets Haruja</p>
        <a
          class="admin-btn"
          target="_blank"
          href="https://docs.google.com/spreadsheets/d/15ofWXeddksQjaUxpHxSlzq6XrqHsl78CHgcorlBabhI/edit?usp=sharing"
        >
          Ir a app
        </a>
      </div>

      <!-- Generar CSV + IVA -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üíæ</span></div>
        <h4>Generar CSV + IVA</h4>
        <p>Actualiza la base que usas para SMP / etiquetas.</p>
        <button
          id="btnCSVConIVA"
          class="admin-btn"
          type="button"
          onclick="ejecutarCSVConIVA()"
        >
          Generar CSV
        </button>
      </div>

      <!-- Resumen del d√≠a -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üìà</span></div>
        <h4>Resumen del d√≠a</h4>
        <p>Ventas, tickets y prendas sin precio.</p>
        <button class="admin-btn" type="button" onclick="verDashboardHoy()">
          Ver resumen
        </button>
      </div>

      <!-- Buscar producto -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üîé</span></div>
        <h4>Buscar producto</h4>
        <p>Consulta r√°pida en Master por c√≥digo o descripci√≥n.</p>
        <button
          class="admin-btn"
          type="button"
          onclick="abrirBuscadorProducto()"
        >
          Buscar
        </button>
      </div>

      <!-- Esc√°ner de c√≥digos (beta) -->
      <div class="admin-card">
        <div class="admin-icon-circle"><span class="admin-icon">üì∑</span></div>
        <h4>Esc√°ner de c√≥digos (beta)</h4>
        <p>Leer c√≥digos con la c√°mara (en desarrollo).</p>
        <a class="admin-btn" href="/scanner.html">Abrir esc√°ner</a>
      </div>
    </div>

    <!-- Overlay de carga -->
    <div
      id="loadingOverlay"
      class="loading-overlay"
      style="display: none"
      aria-hidden="true"
    >
      <div class="loading-box">
        <div class="loading-spinner"></div>
        <div id="loadingMessage">Procesando...</div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" style="display: none"></div>

    <!-- Librer√≠a jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <script>
      const ADMIN_PASSWORD = "Harujagdl";

      const adminToggle = document.getElementById("adminToggle");
      const adminGrid = document.getElementById("adminGrid");
      const publicGrid = document.getElementById("publicGrid");
      const panelTitle = document.getElementById("panelTitle");

      let adminUnlocked = localStorage.getItem("harujaAdmin") === "true";

      function showAdmin() {
        publicGrid.style.display = "none";
        adminGrid.style.display = "grid";
        panelTitle.textContent = "Panel Administrador HarujaGdl";
        adminToggle.textContent = "‚¨ÖÔ∏è Volver al panel";
      }

      function showPublic() {
        publicGrid.style.display = "grid";
        adminGrid.style.display = "none";
        panelTitle.textContent = "Panel de Herramientas HarujaGdl";
        adminToggle.textContent = "üîê Administrador";
      }

      if (adminUnlocked) {
        showAdmin();
      }

      adminToggle.addEventListener("click", () => {
        if (!adminUnlocked) {
          const pass = prompt("Introduce la contrase√±a de administrador:");
          if (pass === ADMIN_PASSWORD) {
            adminUnlocked = true;
            localStorage.setItem("harujaAdmin", "true");
            showAdmin();
          } else {
            showToast("Contrase√±a incorrecta.", "error");
          }
        } else {
          if (adminGrid.style.display === "grid") {
            showPublic();
          } else {
            showAdmin();
          }
        }
      });

      // ============================
      //  Loader + Toast helpers
      // ============================

      const loadingOverlay = document.getElementById("loadingOverlay");
      const loadingMessage = document.getElementById("loadingMessage");
      const toastEl = document.getElementById("toast");
      let toastTimeoutId = null;

      function showLoader(message) {
        if (loadingMessage)
          loadingMessage.textContent = message || "Procesando...";
        if (loadingOverlay) loadingOverlay.style.display = "flex";
      }

      function hideLoader() {
        if (loadingOverlay) loadingOverlay.style.display = "none";
      }

      function showToast(message, type = "info") {
        if (!toastEl) return;

        toastEl.textContent = message || "";
        toastEl.classList.remove(
          "toast--success",
          "toast--error",
          "toast--info",
          "toast--visible"
        );

        if (type === "success") toastEl.classList.add("toast--success");
        else if (type === "error") toastEl.classList.add("toast--error");
        else toastEl.classList.add("toast--info");

        toastEl.style.display = "block";
        requestAnimationFrame(() => {
          toastEl.classList.add("toast--visible");
        });

        if (toastTimeoutId) clearTimeout(toastTimeoutId);
        toastTimeoutId = setTimeout(() => {
          toastEl.classList.remove("toast--visible");
          setTimeout(() => {
            toastEl.style.display = "none";
          }, 250);
        }, 3500);
      }

      // ============================
      //  Endpoints Apps Script
      // ============================

      const PIPELINE_URL =
        "https://script.google.com/macros/s/AKfycbzbB870s_6tuIjlDbN-CWPiEwVDT8r-gz3U_4iRB366JTWhoqbgvXhVld30_D807grl/exec";

      // Usamos el mismo script para info de c√≥digo (action=infoCodigo)
      const API_MASTER_URL = PIPELINE_URL;

      async function ejecutarPipelineMaster() {
        const btn = document.getElementById("btnPipelineMaster");
        const textoOriginal = btn ? btn.textContent : "";

        const confirmar = confirm(
          "¬øQuieres ejecutar la actualizaci√≥n del Master?\n\n" +
            "Esto correr√°: c√≥digos nuevos y precios desde Calculadora."
        );
        if (!confirmar) return;

        try {
          if (btn) {
            btn.disabled = true;
            btn.textContent = "Ejecutando...";
          }

          showLoader("Actualizando Master (c√≥digos + precios)...");

          const respuesta = await fetch(
            PIPELINE_URL + "?action=ejecutarPipeline"
          );
          const data = await respuesta.json();

          if (data.success) {
            showToast(
              data.message ||
                "Pipeline ejecutado correctamente. Revisa el Master.",
              "success"
            );
          } else {
            showToast(
              data.message || "Hubo un problema al ejecutar el pipeline.",
              "error"
            );
          }
        } catch (error) {
          console.error(error);
          showToast(
            "Error al conectar con el Master. Intenta de nuevo.",
            "error"
          );
        } finally {
          hideLoader();
          if (btn) {
            btn.disabled = false;
            btn.textContent = textoOriginal || "Ejecutar actualizaci√≥n";
          }
        }
      }

      async function ejecutarCSVConIVA() {
        const btn = document.getElementById("btnCSVConIVA");
        const textoOriginal = btn ? btn.textContent : "";

        const confirmar = confirm(
          "¬øGenerar el CSV con IVA?\n\n" +
            "Esto actualizar√° la base que usas para SMP / etiquetas."
        );
        if (!confirmar) return;

        try {
          if (btn) {
            btn.disabled = true;
            btn.textContent = "Generando...";
          }

          showLoader("Generando CSV con IVA...");

          const respuesta = await fetch(
            PIPELINE_URL + "?action=generarCSVConIVA"
          );
          const data = await respuesta.json();

          if (data.success) {
            showToast(
              data.message ||
                "CSV con IVA generado correctamente. Revisa el archivo SMP.",
              "success"
            );
          } else {
            showToast(
              data.message || "Hubo un problema al generar el CSV con IVA.",
              "error"
            );
          }
        } catch (error) {
          console.error(error);
          showToast(
            "Error al conectar con el Master. Intenta de nuevo.",
            "error"
          );
        } finally {
          hideLoader();
          if (btn) {
            btn.disabled = false;
            btn.textContent = textoOriginal || "Generar CSV";
          }
        }
      }

      // ============================
      //  Dashboard del d√≠a
      // ============================

      async function verDashboardHoy() {
        showLoader("Cargando resumen del d√≠a...");

        try {
          const respuesta = await fetch(PIPELINE_URL + "?action=dashboardHoy");
          const data = await respuesta.json();

          if (!data.success) {
            showToast(
              data.message || "No se pudo obtener el resumen del d√≠a.",
              "error"
            );
            return;
          }

          const d = data.dashboard || {};
          const ventasHoy = d.ventasHoy || 0;
          const ticketsHoy = d.ticketsHoy || 0;
          const ventasSemana = d.ventasSemana || 0;
          const ventasMes = d.ventasMes || 0;
          const prendasSinPrecio = d.prendasSinPrecio || 0;

          const msg =
            "üìà Resumen del d√≠a\n\n" +
            "üí∏ Ventas hoy: $" +
            ventasHoy.toLocaleString("es-MX") +
            "\n" +
            "üßæ Tickets hoy: " +
            ticketsHoy +
            "\n\n" +
            "üìÖ Ventas √∫ltimos 7 d√≠as: $" +
            ventasSemana.toLocaleString("es-MX") +
            "\n" +
            "üìÜ Ventas del mes: $" +
            ventasMes.toLocaleString("es-MX") +
            "\n\n" +
            "‚ö†Ô∏è Prendas sin precio en Master: " +
            prendasSinPrecio;

          alert(msg);
        } catch (error) {
          console.error(error);
          showToast(
            "Error al conectar con el Master para el dashboard.",
            "error"
          );
        } finally {
          hideLoader();
        }
      }

      // ============================
      //  Buscador de producto
      // ============================

      async function abrirBuscadorProducto() {
        const q = prompt(
          "Buscar producto en Master:\n\n" +
            "Ingresa c√≥digo o parte de la descripci√≥n."
        );
        if (!q) return;

        showLoader("Buscando producto...");

        try {
          const respuesta = await fetch(
            PIPELINE_URL +
              "?action=buscarProducto&q=" +
              encodeURIComponent(q)
          );
          const data = await respuesta.json();

          if (!data.success) {
            showToast(data.message || "Error en la b√∫squeda.", "error");
            return;
          }

          const resultados = data.resultados || [];
          if (!resultados.length) {
            showToast("No se encontraron productos para: " + q, "info");
            return;
          }

          let texto = "Resultados de b√∫squeda (" + resultados.length + "):\n\n";
          resultados.slice(0, 5).forEach((item, idx) => {
            texto +=
              "#" +
              (idx + 1) +
              " " +
              (item.codigo || "") +
              " | " +
              (item.descripcion || "") +
              "\n" +
              "Tipo: " +
              (item.tipo || "-") +
              " | Color: " +
              (item.color || "-") +
              " | Talla: " +
              (item.talla || "-") +
              "\n" +
              "Precio: " +
              (item.precio !== "" ? "$" + item.precio : "N/D") +
              "\n\n";
          });

          alert(texto);
        } catch (error) {
          console.error(error);
          showToast(
            "Error al conectar con el Master para la b√∫squeda.",
            "error"
          );
        } finally {
          hideLoader();
        }
      }

      // ============================
      //  Abrir m√≥dulo de movimientos
      // ============================

      function abrirMovimientosRopa() {
        const seccion = document.getElementById("movimientos-ropa");
        if (!seccion) return;

        seccion.style.display = "block";
        seccion.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // ============================
      //  M√ìDULO MOVIMIENTOS DE ROPA
      // ============================

      (function () {
        const video = document.getElementById("mov-video");
        const canvas = document.getElementById("mov-canvas");
        const ctx = canvas ? canvas.getContext("2d") : null;
        const btnIniciar = document.getElementById("mov-btn-iniciar-scan");
        const btnDetener = document.getElementById("mov-btn-detener-scan");
        const btnGuardar = document.getElementById("mov-btn-guardar");
        const tbody = document.querySelector("#mov-tabla-items tbody");
        const msg = document.getElementById("mov-mensaje");

        if (!video || !canvas || !ctx || !tbody || !btnIniciar) {
          return;
        }

        let stream = null;
        let scanning = false;
        let items = [];

        const hoy = new Date().toISOString().slice(0, 10);
        const inputFecha = document.getElementById("mov-fecha");
        if (inputFecha && !inputFecha.value) inputFecha.value = hoy;

        btnIniciar.addEventListener("click", iniciarScanner);
        btnDetener.addEventListener("click", detenerScanner);
        btnGuardar.addEventListener("click", guardarMovimiento);

        function iniciarScanner() {
          if (scanning) return;

          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            msg.textContent =
              "Tu dispositivo no permite usar la c√°mara desde el navegador.";
            return;
          }

          navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "environment" } })
            .then(function (s) {
              stream = s;
              video.srcObject = s;
              video.setAttribute("playsinline", true);
              video.play();
              scanning = true;
              btnIniciar.disabled = true;
              btnDetener.disabled = false;
              requestAnimationFrame(tick);
            })
            .catch(function (err) {
              console.error(err);
              msg.textContent = "No se pudo acceder a la c√°mara: " + err.message;
            });
        }

        function detenerScanner() {
          scanning = false;
          btnIniciar.disabled = false;
          btnDetener.disabled = true;
          if (stream) {
            stream.getTracks().forEach((t) => t.stop());
          }
        }

        function tick() {
          if (!scanning) return;

          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            const code = jsQR(imageData.data, canvas.width, canvas.height, {
              inversionAttempts: "dontInvert",
            });

            if (code && code.data) {
              const codigo = code.data.trim();

              if (!items.find((it) => it.codigo === codigo)) {
                agregarItemPorCodigo(codigo);
                scanning = false;
                setTimeout(() => {
                  scanning = true;
                  requestAnimationFrame(tick);
                }, 800);
                return;
              }
            }
          }
          requestAnimationFrame(tick);
        }

        // üöö Consultar info del c√≥digo en el Master v√≠a API (fetch)
        function agregarItemPorCodigo(codigo) {
          msg.textContent = "Buscando info del c√≥digo " + codigo + "...";

          fetch(
            API_MASTER_URL +
              "?action=infoCodigo&codigo=" +
              encodeURIComponent(codigo)
          )
            .then((resp) => resp.json())
            .then((data) => {
              if (!data || !data.success || !data.info) {
                msg.textContent =
                  (data && data.message) ||
                  "C√≥digo " + codigo + " no encontrado en el Master.";
                return;
              }

              const info = data.info || {};

              const item = {
                codigo: info.codigo || codigo,
                descripcion: info.descripcion || "",
                color: info.color || "",
                talla: info.talla || "",
                tipo: info.tipo || "",
                precio:
                  info.precio !== undefined &&
                  info.precio !== null &&
                  info.precio !== ""
                    ? Number(info.precio)
                    : "",
              };

              if (items.find((it) => it.codigo === item.codigo)) {
                msg.textContent = "El c√≥digo ya estaba agregado.";
                return;
              }

              items.push(item);
              renderTabla();
              msg.textContent = "Producto agregado: " + item.codigo;
            })
            .catch((err) => {
              console.error(err);
              msg.textContent =
                "Error al buscar la informaci√≥n del c√≥digo en el Master.";
            });
        }

        function renderTabla() {
          tbody.innerHTML = "";
          items.forEach((item, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${item.codigo || ""}</td>
              <td>${item.descripcion || ""}</td>
              <td>${item.color || ""}</td>
              <td>${item.talla || ""}</td>
              <td>${item.tipo || ""}</td>
              <td>${
                item.precio !== "" && item.precio !== undefined
                  ? "$" + Number(item.precio).toFixed(2)
                  : ""
              }</td>
              <td><button type="button" data-index="${index}">Quitar</button></td>
            `;
            tbody.appendChild(tr);
          });

          tbody.querySelectorAll("button[data-index]").forEach((btn) => {
            btn.addEventListener("click", function () {
              const i = parseInt(this.getAttribute("data-index"), 10);
              items.splice(i, 1);
              renderTabla();
            });
          });
        }

        // üö© Guardar movimiento (pendiente de backend)
        function guardarMovimiento() {
          if (!items.length) {
            msg.textContent = "Agrega al menos una prenda antes de guardar.";
            return;
          }

          const data = {
            fecha: document.getElementById("mov-fecha").value,
            tipo: document.getElementById("mov-tipo").value,
            responsable: document.getElementById("mov-responsable").value,
            comentarios: document.getElementById("mov-comentarios").value,
            items: items,
          };

          console.log("Datos a guardar (pendiente backend):", data);

          msg.textContent =
            "Guardando movimiento (esta parte se termina cuando definamos el endpoint en Apps Script)‚Ä¶";
        }
      })();
    </script>
  </body>
</html>
