<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Venta – HarujaGdl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA: usar mismo look que tu panel -->
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background:#fff;
      color:#383234;
      margin:0;
      padding:0 20px;
    }
    .container {
      max-width:600px;
      margin:auto;
      padding-bottom:40px;
    }
    img.logo {
      width:250px;
      display:block;
      margin:30px auto 20px;
    }
    h2 {
      text-align:center;
      color:#383234;
      margin-bottom:20px;
    }
    label {
      display:block;
      margin-top:15px;
      font-weight:bold;
    }
    input,select,textarea {
      width:100%;
      padding:8px;
      border:1px solid #ccc;
      border-radius:5px;
      margin-top:5px;
      font-family:inherit;
    }
    button {
      margin-top:25px;
      width:100%;
      padding:12px;
      background:#A7B59E;
      color:#fff;
      border:0;
      border-radius:8px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
    }
    button:disabled {
      opacity:.7;
      cursor:default;
    }
    .mensaje {
      margin-top:20px;
      text-align:center;
      font-weight:bold;
    }
    .muted {
      color:#6b7280;
      font-size:.9rem;
      text-align:center;
    }

    /* Popups */
    dialog {
      border:none;
      border-radius:12px;
      padding:25px 30px;
      text-align:center;
      animation:fadeIn .3s ease;
      font-weight:500;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:scale(0.9); }
      to   { opacity:1; transform:scale(1); }
    }
    .success { background-color:#A7B59E; color:#fff; }
    .error   { background-color:#B0413E; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://i.postimg.cc/nMphkZcC/haruja-logo.png" alt="Haruja Logo" class="logo" />
    <h2>Registro de Venta</h2>

    <form id="ventaForm" autocomplete="off">
      <label>Fecha de venta*</label>
      <input type="date" name="fecha" required>

      <label>Vendedora*</label>
      <select name="vendedora" required>
        <option value="Sam">Sam</option>
        <option value="Haru">Haru</option>
        <option value="harujagdl.com">harujagdl.com</option>
      </select>

      <label>Cliente*</label>
      <input type="text" name="cliente" required>

      <label>Número de contacto*</label>
      <input type="tel" name="contacto" required>

      <label>Canal de venta*</label>
      <select name="canal" required>
        <option value="Tienda física">Tienda física</option>
        <option value="Harujagdl.com">Harujagdl.com</option>
        <option value="Insta">Instagram</option>
        <option value="Facebook">Facebook</option>
        <option value="Whatsapp">Whatsapp</option>
        <option value="Tianguis">Tianguis</option>
      </select>

      <label>Código(s) (separar con ,)*</label>
      <input type="text" name="articulo" required placeholder="Ej. HA1001, HA1002, HA1003">

      <label>Total*</label>
      <input type="number" name="precio" required step="0.01" min="0">

      <label>Método de pago*</label>
      <select name="pago" required>
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Transferencia">Transferencia</option>
        <option value="Link de pago">Link de pago</option>
      </select>

      <label>Descuento*</label>
      <select name="descuento" required>
        <option value="No aplica">No aplica</option>
        <option value="10%">10%</option>
      </select>

      <label>Comentario</label>
      <textarea name="comentario" rows="3"></textarea>

      <button id="btnGuardar" type="submit">Guardar venta</button>
      <div class="mensaje" id="mensaje"></div>
      <div class="muted" id="aviso">
        Esta versión se conecta al registro de ventas de Google Sheets.
      </div>
    </form>
  </div>

  <!-- Pop-ups -->
  <dialog id="dlgOk"  class="success">✅ Venta registrada correctamente.</dialog>
  <dialog id="dlgErr" class="error">❌ Error al guardar la venta.</dialog>

  <script>
    // URL de tu Apps Script (implementación actual)
    const API_URL = "https://script.google.com/macros/s/AKfycbwkty3K4kZlK_83GRoO0GSf2o7B3aHb2VmuhxtcyK4L4FnWSj7yE7MDdUuvdV32WbFh0g/exec";

    const form    = document.getElementById('ventaForm');
    const mensaje = document.getElementById('mensaje');
    const dlgOk   = document.getElementById('dlgOk');
    const dlgErr  = document.getElementById('dlgErr');
    const btn     = document.getElementById('btnGuardar');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const datos = Object.fromEntries(new FormData(form).entries());

      // Payload que espera nuestro doPost (action + payload)
      const body = {
        action: "registrarVenta",
        payload: {
          fechaVenta: datos.fecha,
          vendedora:  datos.vendedora,
          cliente:    datos.cliente,
          telefono:   datos.contacto,
          canal:      datos.canal,
          articulo:   datos.articulo,
          precio:     datos.precio,
          metodoPago: datos.pago,
          descuento:  datos.descuento,
          comentario: datos.comentario
        }
      };

      mensaje.textContent = "Guardando...";
      btn.disabled = true;

      try {
        // IMPORTANTE: no-cors porque Apps Script no expone CORS.
        await fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        // Si no truena el fetch, asumimos éxito
        mensaje.textContent = "";
        dlgOk.textContent = "✅ Venta registrada correctamente.";
        dlgOk.showModal();
        setTimeout(() => dlgOk.close(), 2200);
        form.reset();
      } catch (err) {
        console.error(err);
        mensaje.textContent = "";
        dlgErr.textContent = "❌ Error al guardar la venta. Revisa tu conexión.";
        dlgErr.showModal();
        setTimeout(() => dlgErr.close(), 3000);
      } finally {
        btn.disabled = false;
      }
    });

    // Evitar enviar con Enter fuera de textarea
    form.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' && ev.target.tagName !== 'TEXTAREA') {
        ev.preventDefault();
      }
    });
  </script>
</body>
</html>
