<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#A7B59E" />
  <title>Panel HarujaGdl â€¢ Comisiones</title>

  <style>
    :root{
      --fondo:#fff;
      --texto:#383234;
      --acento:#A7B59E;
      --beige:#FAF6F1;
      --gris:#6b6b6b;
      --borde:#e9e4dc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Montserrat", system-ui, -apple-system, "Segoe UI", sans-serif;
      background:var(--beige);
      color:var(--texto);
    }
    .wrap{max-width:720px;margin:0 auto;padding:20px 14px 60px;}
    header{display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px 0 18px}
    header img{height:40px;object-fit:contain}
    h1{font-size:20px;margin:0}
    .sub{color:var(--gris);font-size:13px;text-align:center;max-width:520px}
    .card{
      background:var(--fondo);
      border:1px solid var(--borde);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(56,50,52,.06);
      margin-bottom:12px;
    }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input, select, textarea, button{
      font:inherit;
      border-radius:10px;
      border:1px solid var(--borde);
      padding:10px 12px;
      background:#fff;
      color:var(--texto);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--acento)}
    .btn{
      background:var(--acento);
      border:1px solid var(--acento);
      color:#fff;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:600;
    }
    .btn.secondary{
      background:#fff;color:var(--texto);border:1px solid var(--borde);
    }
    .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:var(--beige);
      border:1px solid var(--borde);
      font-size:12px;
      color:var(--gris);
    }
    .order{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .order h3{margin:0;font-size:16px}
    .meta{color:var(--gris);font-size:13px;margin-top:4px;line-height:1.35}
    .items{margin-top:10px;color:var(--texto);font-size:13px;line-height:1.35}
    .actions{display:flex;gap:8px;align-items:center}
    .footerActions{display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .hint{color:var(--gris);font-size:12px}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--borde);
      box-shadow:0 20px 50px rgba(0,0,0,.2);
      padding:14px;
    }
    .modal h2{margin:0 0 10px 0; font-size:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){ .grid{grid-template-columns:1fr 1fr} }
    .full{grid-column:1/-1}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      background:#fff;
      border:1px solid var(--borde);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
      display:none;
      font-size:13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- Cambia el src por tu logo si quieres -->
      <img src="/haruja-logo.png" alt="harujagdl" onerror="this.style.display='none'">
      <h1>Comisiones â€¢ Tiendanube</h1>
      <div class="sub">AquÃ­ no recapturas ventas. Solo asignas <b>vendedora</b> y <b>origen real</b> a los pedidos del PDV/checkout para comisiones.</div>
    </header>

    <div class="card">
      <div class="toolbar">
        <select id="view">
          <option value="pendientes" selected>Pendientes por asignar</option>
          <option value="todos">Todos (TN_Resumen)</option>
        </select>

        <input id="q" placeholder="Buscar: # pedido, nombre, telÃ©fono, emailâ€¦" style="flex:1;min-width:240px" />
        <button class="btn secondary" id="btnBuscar">Buscar</button>
        <button class="btn" id="btnRefrescar">Refrescar</button>
      </div>
      <div style="margin-top:10px" class="footerActions">
        <div class="hint">Mostrando <span id="count">0</span> â€¢ Total <span id="total">0</span></div>
        <div class="actions">
          <button class="btn secondary" id="btnNext" disabled>Siguiente â†’</button>
        </div>
      </div>
    </div>

    <div id="list"></div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h2>Asignar venta para comisiones</h2>
      <div class="pill" id="mOrder"></div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label class="hint">Vendedora*</label>
          <select id="mVendedora" style="width:100%">
            <option value="">Seleccionaâ€¦</option>
            <option>Sam</option>
            <option>Haru</option>
            <option>Yair</option>
          </select>
        </div>
        <div>
          <label class="hint">Origen real*</label>
          <select id="mOrigen" style="width:100%">
            <option value="">Seleccionaâ€¦</option>
            <option>Instagram</option>
            <option>Facebook</option>
            <option>WhatsApp</option>
            <option>OrgÃ¡nico (web)</option>
            <option>Tienda fÃ­sica</option>
            <option>Tianguis</option>
            <option>Referido</option>
          </select>
        </div>

        <div class="full">
          <label class="hint">Comentario</label>
          <textarea id="mComentario" rows="3" style="width:100%" placeholder="Ej: lo atendiÃ³ Sam por WhatsApp, cerrÃ³ en webâ€¦"></textarea>
        </div>

        <div class="full" style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn secondary" id="mCancelar">Cancelar</button>
          <button class="btn" id="mGuardar">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= CONFIG =========
    const API_BASE = "https://script.google.com/macros/s/AKfycbz51hV2sc5Ho_tBcaygWp1qfcLdeXgsQZ1m7aRV_6CHp80piwEoDfiuBSJXrSMoGFS4/exec";
    const API_KEY  = "harujaTNpwa2025";

    // ========= JSONP helper (evita CORS) =========
    function jsonp(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const url = new URL(API_BASE);

        url.searchParams.set("action", action);
        url.searchParams.set("key", API_KEY);
        url.searchParams.set("callback", cb);

        Object.entries(params).forEach(([k,v]) => {
          if (v === undefined || v === null) return;
          url.searchParams.set(k, String(v));
        });

        window[cb] = (data) => {
          cleanup();
          resolve(data);
        };

        function cleanup() {
          try { delete window[cb]; } catch(e){ window[cb] = undefined; }
          script.remove();
        }

        script.onerror = () => {
          cleanup();
          reject(new Error("No se pudo cargar la respuesta (JSONP)."));
        };

        script.src = url.toString();
        document.body.appendChild(script);

        // timeout
        setTimeout(() => {
          if (window[cb]) {
            cleanup();
            reject(new Error("Timeout de la API"));
          }
        }, 15000);
      });
    }

    // ========= UI state =========
    let state = {
      offset: 0,
      limit: 10,
      nextOffset: null,
      currentCards: [],
      selected: null
    };

    const elList = document.getElementById("list");
    const elCount = document.getElementById("count");
    const elTotal = document.getElementById("total");
    const elNext = document.getElementById("btnNext");
    const elView = document.getElementById("view");
    const elQ = document.getElementById("q");
    const toast = document.getElementById("toast");

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=>toast.style.display="none", 2600);
    }

    function money(v) {
      const n = Number(v);
      if (isNaN(n)) return String(v ?? "");
      return n.toLocaleString("es-MX", { style:"currency", currency:"MXN" });
    }

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function render(cards=[]) {
      elList.innerHTML = "";
      if (!cards.length) {
        elList.innerHTML = `<div class="card"><div class="hint">Sin resultados. ðŸŽˆ</div></div>`;
        return;
      }

      cards.forEach(c => {
        const itemsPreview = (c.items_text || "").slice(0, 160);
        const status = c.status ? `<span class="pill">${esc(c.status)}</span>` : "";
        const conv = (String(c.convertido).toLowerCase() === "true" || String(c.convertido) === "1")
          ? `<span class="pill">âœ… Ya asignado</span>` : `<span class="pill">ðŸ•’ Pendiente</span>`;

        const html = `
          <div class="card">
            <div class="order">
              <div>
                <h3>TN-${esc(c.order_number || "")} <span style="font-weight:500;color:var(--gris);font-size:13px">(${esc(c.order_id || "")})</span></h3>
                <div class="meta">
                  <div><b>${esc(c.customer_name || "Sin nombre")}</b> â€¢ ${esc(c.customer_phone || "")} â€¢ ${esc(c.customer_email || "")}</div>
                  <div>Total: <b>${esc(money(c.total))}</b></div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                ${status}
                ${conv}
                <button class="btn" data-assign="${esc(c.order_id)}">Asignar</button>
              </div>
            </div>
            <div class="items">${esc(itemsPreview)}${(c.items_text || "").length>160 ? "â€¦" : ""}</div>
          </div>
        `;
        elList.insertAdjacentHTML("beforeend", html);
      });

      // bind botones
      document.querySelectorAll("[data-assign]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-assign");
          const found = state.currentCards.find(x => String(x.order_id) === String(id));
          if (found) openModal(found);
        });
      });
    }

    async function load(reset=false) {
      if (reset) state.offset = 0;

      const view = elView.value;
      const q = elQ.value.trim();

      const action = (view === "pendientes") ? "tn_pendientes" : "tn_resumen";
      const res = await jsonp(action, {
        limit: state.limit,
        offset: state.offset,
        order: "desc",
        q: q || ""
      });

      if (!res || !res.ok) {
        showToast(res?.error || "Error al cargar.");
        render([]);
        return;
      }

      state.currentCards = res.cards || [];
      state.nextOffset = res.nextOffset;

      elCount.textContent = String(res.count || 0);
      elTotal.textContent = String(res.total || 0);

      elNext.disabled = (state.nextOffset === null);
      render(state.currentCards);
    }

    // ========= Modal =========
    const modalBack = document.getElementById("modalBack");
    const mOrder = document.getElementById("mOrder");
    const mVendedora = document.getElementById("mVendedora");
    const mOrigen = document.getElementById("mOrigen");
    const mComentario = document.getElementById("mComentario");

    function openModal(card) {
      state.selected = card;
      mOrder.textContent = `Pedido: TN-${card.order_number} (order_id: ${card.order_id})`;
      mVendedora.value = "";
      mOrigen.value = "";
      mComentario.value = "";
      modalBack.style.display = "flex";
    }
    function closeModal(){ modalBack.style.display = "none"; state.selected = null; }

    document.getElementById("mCancelar").addEventListener("click", closeModal);

    document.getElementById("mGuardar").addEventListener("click", async () => {
      if (!state.selected) return;

      const vendedora = mVendedora.value.trim();
      const origen = mOrigen.value.trim();
      const comentario = mComentario.value.trim();

      if (!vendedora) return showToast("Selecciona vendedora.");
      if (!origen) return showToast("Selecciona origen.");

      const res = await jsonp("registrar_comision", {
        order_id: state.selected.order_id,
        vendedora,
        origen,
        comentario
      });

      if (!res || !res.ok) {
        showToast(res?.error || "No se pudo guardar.");
        return;
      }

      showToast("âœ… Guardado para comisiones");
      closeModal();

      // recargar (sin perder bÃºsqueda)
      await load(true);
    });

    // ========= Eventos =========
    document.getElementById("btnRefrescar").addEventListener("click", () => load(true));
    document.getElementById("btnBuscar").addEventListener("click", () => load(true));
    elView.addEventListener("change", () => load(true));

    elNext.addEventListener("click", () => {
      if (state.nextOffset !== null) {
        state.offset = state.nextOffset;
        load(false);
      }
    });

    // init
    load(true).catch(err => showToast(err.message || "Error"));
  </script>
</body>
</html>
