<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#A7B59E" />
  <title>Panel HarujaGdl ‚Ä¢ Comisiones</title>

  <style>
    :root{
      --fondo:#fff;
      --texto:#383234;
      --acento:#A7B59E;
      --beige:#FAF6F1;
      --gris:#6b6b6b;
      --borde:#e9e4dc;
      --shadow: 0 10px 30px rgba(56,50,52,.10);
      --shadowSoft: 0 6px 18px rgba(56,50,52,.06);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Montserrat", system-ui, -apple-system, "Segoe UI", sans-serif;
      background:var(--beige);
      color:var(--texto);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 72px;}
    header{display:flex;flex-direction:column;align-items:center;gap:10px;padding:8px 0 14px}
    header img{height:40px;object-fit:contain}
    h1{font-size:20px;margin:0;text-align:center}
    .sub{color:var(--gris);font-size:13px;text-align:center;max-width:720px;line-height:1.35}

    .card{
      background:var(--fondo);
      border:1px solid var(--borde);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadowSoft);
      margin-bottom:12px;
    }

    .controls{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(to bottom, rgba(250,246,241,.98), rgba(250,246,241,.86));
      backdrop-filter:saturate(140%) blur(6px);
      padding:10px 0;
      margin:0 -14px 10px;
    }
    .controlsInner{max-width:980px;margin:0 auto;padding:0 14px;}

    .toolbar{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:center;
    }

    input, select, textarea, button{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--borde);
      padding:11px 12px;
      background:#fff;
      color:var(--texto);
      outline:none;
      transition:border-color .15s ease, transform .08s ease;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--acento)}
    button:active{transform:scale(.99)}
    .btn{
      background:var(--acento);
      border:1px solid var(--acento);
      color:#fff;
      cursor:pointer;
      padding:11px 14px;
      border-radius:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .btn.secondary{
      background:#fff;color:var(--texto);border:1px solid var(--borde);
      font-weight:800;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    @media (min-width: 760px){
      .toolbar{grid-template-columns: 240px 1fr auto auto;}
    }

    .rowInfo{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      align-items:center;padding-top:2px;
    }
    .hint{color:var(--gris);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background:var(--beige);border:1px solid var(--borde);
      font-size:12px;color:var(--gris);line-height:1;
    }
    .pill strong{color:var(--texto);font-weight:800}

    /* Chips */
    .chips{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--borde);
      background:#fff;
      color:var(--texto);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip small{
      color:var(--gris);
      font-weight:700;
    }
    .chip.active{
      border-color:var(--acento);
      box-shadow:0 0 0 3px rgba(167,181,158,.25);
    }

    /* Toggle */
    .toggleRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .toggle{display:inline-flex;align-items:center;gap:8px;user-select:none;cursor:pointer;font-size:13px;color:var(--gris)}
    .toggle input{width:18px;height:18px}

    /* Lista */
    #list{display:grid;grid-template-columns:1fr;gap:12px}
    .order{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .order h3{margin:0;font-size:16px}
    .meta{color:var(--gris);font-size:13px;margin-top:6px;line-height:1.35}
    .items{margin-top:10px;color:var(--texto);font-size:13px;line-height:1.35;word-break:break-word}
    .rightCol{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:160px}

    .miniActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .miniBtn{
      border:1px solid var(--borde);
      background:#fff;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }

    details{margin-top:10px}
    details summary{
      cursor:pointer;
      color:var(--gris);
      font-size:13px;
      user-select:none;
    }

    @media (max-width: 480px){
      .rightCol{min-width:auto;align-items:flex-start}
      .order{flex-direction:column}
      .btn{width:100%}
    }

    /* Skeleton */
    .skeleton{
      animation:pulse 1.15s ease-in-out infinite;
      background:linear-gradient(90deg, #f5f1ea, #fff, #f5f1ea);
      background-size:200% 100%;
      border:1px solid var(--borde);
      border-radius:var(--radius);
      height:140px;
    }
    @keyframes pulse{0%{background-position:0% 0%}100%{background-position:-200% 0%}}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:100;
    }
    .modal{
      width:min(560px,100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--borde);
      box-shadow:0 20px 50px rgba(0,0,0,.20);
      padding:14px;
    }
    .modal h2{margin:0 0 10px 0;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){ .grid{grid-template-columns:1fr 1fr} }
    .full{grid-column:1/-1}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:16px;background:#fff;border:1px solid var(--borde);
      border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);
      display:none;font-size:13px;z-index:200;
      max-width:min(92vw,560px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .pagerBtns{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <img src="/haruja-logo.png" alt="harujagdl" onerror="this.style.display='none'">
      <h1>Comisiones ‚Ä¢ Tiendanube</h1>
      <div class="sub">
        Aqu√≠ no recapturas ventas. Solo asignas <b>vendedora</b> y <b>origen real</b> a los pedidos del PDV/checkout para comisiones.
      </div>
    </header>

    <div class="controls">
      <div class="controlsInner">
        <div class="card" style="margin:0">
          <div class="toolbar">
            <select id="view" aria-label="Vista">
              <option value="pendientes" selected>Pendientes por asignar</option>
              <option value="todos">Todos (TN_Resumen)</option>
            </select>

            <input id="q" placeholder="Buscar: # pedido, nombre, tel√©fono, email‚Ä¶" />

            <button class="btn secondary" id="btnBuscar">Buscar</button>
            <button class="btn" id="btnRefrescar">Refrescar</button>
          </div>

          <div class="chips" id="chips"></div>

          <div class="rowInfo" style="margin-top:10px">
            <div class="toggleRow">
              <label class="toggle" title="Por default no se muestran pedidos cancelados">
                <input type="checkbox" id="includeCancelled" />
                Incluir canceladas
              </label>

              <label class="toggle" title="En vista Todos, muestra solo los que ya se asignaron hoy (best-effort)">
                <input type="checkbox" id="onlyAssignedToday" />
                Asignados hoy
              </label>

              <span class="pill">
                Mostrando <strong><span id="count">0</span></strong>
                ‚Ä¢ Total <strong><span id="total">0</span></strong>
              </span>
              <span class="hint" id="hintStatus">Listo.</span>
            </div>

            <div class="pagerBtns">
              <button class="btn secondary" id="btnPrev" disabled>‚Üê Anterior</button>
              <button class="btn secondary" id="btnNext" disabled>Siguiente ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="list"></div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h2 id="modalTitle">Asignar venta para comisiones</h2>
      <div class="pill" id="mOrder"></div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label class="hint">Vendedora*</label>
          <select id="mVendedora" style="width:100%">
            <option value="">Selecciona‚Ä¶</option>
            <option>Vendedora</option>
            <option>harujagdl.com</option>
            <option>Haru</option>
            <option>Yair</option>
          </select>
        </div>
        <div>
          <label class="hint">Origen real*</label>
          <select id="mOrigen" style="width:100%">
            <option value="">Selecciona‚Ä¶</option>
            <option>Instagram</option>
            <option>Facebook</option>
            <option>WhatsApp</option>
            <option>Org√°nico (web)</option>
            <option>Tienda f√≠sica</option>
            <option>Tianguis</option>
            <option>Referido</option>
          </select>
        </div>

        <div class="full">
          <label class="hint">Comentario</label>
          <textarea id="mComentario" rows="3" style="width:100%" placeholder="Ej: lo atendi√≥ X por WhatsApp, cerr√≥ en web‚Ä¶"></textarea>
        </div>

        <div class="full" style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
          <button class="btn secondary" id="mCancelar">Cancelar</button>
          <button class="btn" id="mGuardar">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= CONFIG =========
    // Proxy Vercel (misma-origin) -> evita CORS/JSONP y funciona en Chrome/iOS PWA
    const API_BASE = "/api/gs";
    const API_KEY  = "harujaTNpwa2025";

    // ========= API helper (fetch + proxy Vercel) =========
    async function api(action, params = {}) {
      const url = new URL(API_BASE, window.location.origin);

      url.searchParams.set("action", String(action || "").trim());
      url.searchParams.set("key", API_KEY);

      // anti-cache
      url.searchParams.set("_ts", String(Date.now()));
      url.searchParams.set("_r", Math.random().toString(36).slice(2));

      Object.entries(params).forEach(([k, v]) => {
        if (v === undefined || v === null) return;
        url.searchParams.set(k, String(v));
      });

      const res = await fetch(url.toString(), {
        method: "GET",
        cache: "no-store",
        headers: { "Accept": "application/json" }
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        throw new Error("Respuesta no-JSON del servidor: " + (text || "").slice(0, 140));
      }

      if (!res.ok || data?.ok === false) {
        throw new Error(data?.error || `Error API (${res.status})`);
      }
      return data;
    }

    // ========= UI state =========
    let state = {
      offset: 0,
      limit: 10,
      nextOffset: null,
      currentCards: [],
      selected: null,
      chip: "all",
      lastRawCards: []
    };

    const elList = document.getElementById("list");
    const elCount = document.getElementById("count");
    const elTotal = document.getElementById("total");
    const elNext = document.getElementById("btnNext");
    const elPrev = document.getElementById("btnPrev");
    const elView = document.getElementById("view");
    const elQ = document.getElementById("q");
    const elIncludeCancelled = document.getElementById("includeCancelled");
    const elOnlyAssignedToday = document.getElementById("onlyAssignedToday");
    const elHintStatus = document.getElementById("hintStatus");
    const elChips = document.getElementById("chips");
    const toast = document.getElementById("toast");

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=>toast.style.display="none", 2600);
    }
    function setHint(msg){ elHintStatus.textContent = msg; }

    function money(v) {
      const n = Number(v);
      if (isNaN(n)) return String(v ?? "");
      return n.toLocaleString("es-MX", { style:"currency", currency:"MXN" });
    }
    function esc(s){
      return String(s ?? "")
        .replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function statusKey(s){
      return String(s || "").trim().toLowerCase() || "sin_status";
    }

    function isAssignedToday(card){
      const conv = String(card.convertido || "").toLowerCase();
      return (conv === "true" || conv === "1");
    }

    function applyFrontFilters(raw){
      let out = raw.slice();

      if (state.chip !== "all") {
        out = out.filter(c => statusKey(c.status) === state.chip);
      }
      if (elView.value === "todos" && elOnlyAssignedToday.checked) {
        out = out.filter(c => isAssignedToday(c));
      }
      return out;
    }

    function renderChips(rawCards){
      const counts = {};
      rawCards.forEach(c => {
        const k = statusKey(c.status);
        counts[k] = (counts[k] || 0) + 1;
      });

      const defs = [
        { key:"all", label:"Todos", count: rawCards.length },
        { key:"paid", label:"Paid", count: counts["paid"] || 0 },
        { key:"open", label:"Open", count: counts["open"] || 0 },
        { key:"delivered", label:"Delivered", count: counts["delivered"] || 0 },
        { key:"pending", label:"Pending", count: counts["pending"] || 0 },
      ];

      if (elIncludeCancelled.checked) {
        defs.push({ key:"cancelled", label:"Cancelled", count: counts["cancelled"] || 0 });
      }

      elChips.innerHTML = defs.map(d => `
        <button class="chip ${state.chip===d.key ? "active":""}" data-chip="${d.key}">
          ${d.label} <small>${d.count}</small>
        </button>
      `).join("");

      elChips.querySelectorAll("[data-chip]").forEach(b => {
        b.addEventListener("click", () => {
          state.chip = b.getAttribute("data-chip");
          const filtered = applyFrontFilters(state.lastRawCards);
          render(filtered);
          elCount.textContent = String(filtered.length);
          setHint(`Filtro: ${state.chip === "all" ? "Todos" : state.chip}`);
        });
      });
    }

    function showLoading() {
      elList.innerHTML = "";
      for (let i=0;i<6;i++){
        const sk = document.createElement("div");
        sk.className = "skeleton";
        elList.appendChild(sk);
      }
    }

    function render(cards=[]) {
      elList.innerHTML = "";
      if (!cards.length) {
        elList.innerHTML = `<div class="card"><div class="hint">Sin resultados. üéà</div></div>`;
        return;
      }

      cards.forEach(c => {
        const itemsFull = String(c.items_text || "");
        const itemsPreview = itemsFull.slice(0, 180);
        const status = c.status ? `<span class="pill">üßæ ${esc(c.status)}</span>` : "";
        const conv = (String(c.convertido).toLowerCase() === "true" || String(c.convertido) === "1")
          ? `<span class="pill">‚úÖ Ya asignado</span>` : `<span class="pill">üïí Pendiente</span>`;

        const orderNum = c.order_number ? `TN-${esc(c.order_number)}` : `TN`;
        const customer = esc(c.customer_name || "Sin nombre");
        const phone = esc(c.customer_phone || "");
        const email = esc(c.customer_email || "");
        const total = esc(money(c.total));

        const html = `
          <div class="card">
            <div class="order">
              <div style="min-width:0">
                <h3>${orderNum}
                  <span style="font-weight:500;color:var(--gris);font-size:13px">
                    (${esc(c.order_id || "")})
                  </span>
                </h3>
                <div class="meta">
                  <div><b>${customer}</b>${phone ? ` ‚Ä¢ ${phone}` : ""}${email ? ` ‚Ä¢ ${email}` : ""}</div>
                  <div>Total: <b>${total}</b></div>

                  <div class="miniActions">
                    ${phone ? `<button class="miniBtn" data-copy="${esc(phone)}">Copiar tel</button>` : ""}
                    ${email ? `<button class="miniBtn" data-copy="${esc(email)}">Copiar email</button>` : ""}
                  </div>
                </div>
              </div>

              <div class="rightCol">
                ${status}
                ${conv}
                <button class="btn" data-assign="${esc(c.order_id)}">Asignar</button>
              </div>
            </div>

            <div class="items">${esc(itemsPreview)}${itemsFull.length>180 ? "‚Ä¶" : ""}</div>

            ${itemsFull.length > 180 ? `
              <details>
                <summary>Ver detalle de items</summary>
                <div class="items" style="margin-top:8px">${esc(itemsFull)}</div>
              </details>
            ` : ""}

          </div>
        `;
        elList.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll("[data-assign]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-assign");
          const found = state.currentCards.find(x => String(x.order_id) === String(id));
          if (found) openModal(found);
        });
      });

      document.querySelectorAll("[data-copy]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const val = btn.getAttribute("data-copy") || "";
          try {
            await navigator.clipboard.writeText(val);
            showToast("üìã Copiado");
          } catch(e){
            const ta = document.createElement("textarea");
            ta.value = val;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            showToast("üìã Copiado");
          }
        });
      });
    }

    function updatePager() {
      elNext.disabled = (state.nextOffset === null);
      elPrev.disabled = (state.offset <= 0);
    }

    async function load(reset=false) {
      try{
        if (reset) state.offset = 0;

        const view = elView.value;
        const q = elQ.value.trim();
        const includeCancelled = elIncludeCancelled.checked;

        const action = (view === "pendientes") ? "tn_pendientes" : "tn_resumen";

        setHint("Cargando‚Ä¶");
        showLoading();

        const res = await api(action, {
          limit: state.limit,
          offset: state.offset,
          order: "desc",
          q: q || "",
          includeCancelled: includeCancelled ? 1 : 0
        });

        state.currentCards = res.cards || [];
        state.lastRawCards = res.cards || [];
        state.nextOffset = (res.nextOffset === undefined ? null : res.nextOffset);

        renderChips(state.lastRawCards);

        const filtered = applyFrontFilters(state.lastRawCards);
        render(filtered);

        elCount.textContent = String(filtered.length);
        elTotal.textContent = String(res.total || 0);

        updatePager();

        const label = (view === "pendientes") ? "Pendientes listos." : "Mostrando TN_Resumen.";
        setHint(label);
      } catch(err){
        setHint("Error de conexi√≥n.");
        showToast(err?.message || "Error");
        state.currentCards = [];
        state.lastRawCards = [];
        render([]);
        updatePager();
      }
    }

    // ========= Modal =========
    const modalBack = document.getElementById("modalBack");
    const mOrder = document.getElementById("mOrder");
    const mVendedora = document.getElementById("mVendedora");
    const mOrigen = document.getElementById("mOrigen");
    const mComentario = document.getElementById("mComentario");
    const btnGuardar = document.getElementById("mGuardar");

    function openModal(card) {
      state.selected = card;
      mOrder.textContent = `Pedido: TN-${card.order_number} (order_id: ${card.order_id})`;
      mVendedora.value = "";
      mOrigen.value = "";
      mComentario.value = "";
      modalBack.style.display = "flex";
      setTimeout(()=>mVendedora.focus(), 50);
    }
    function closeModal(){
      modalBack.style.display = "none";
      state.selected = null;
      btnGuardar.disabled = false;
      btnGuardar.textContent = "Guardar";
    }

    document.getElementById("mCancelar").addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalBack.style.display === "flex") closeModal(); });

    document.getElementById("mGuardar").addEventListener("click", async () => {
      try {
        if (!state.selected) return;

        const vendedora = mVendedora.value.trim();
        const origen = mOrigen.value.trim();
        const comentario = mComentario.value.trim();

        if (!vendedora) return showToast("Selecciona vendedora.");
        if (!origen) return showToast("Selecciona origen.");

        btnGuardar.disabled = true;
        btnGuardar.textContent = "Guardando‚Ä¶";

        // üîí Bloqueo si el pedido est√° cancelado
        if (String(state.selected.status || "").toLowerCase() === "cancelled") {
          btnGuardar.disabled = false;
          btnGuardar.textContent = "Guardar";
          showToast("‚ùå Pedido cancelado. No se puede registrar comisi√≥n.");
          return;
        }

        await api("registrar_comision", {
          order_id: state.selected.order_id,
          vendedora,
          origen,
          comentario
        });

        showToast("‚úÖ Guardado para comisiones");
        closeModal();
        await load(true);
      } catch (e) {
        btnGuardar.disabled = false;
        btnGuardar.textContent = "Guardar";
        showToast(e?.message || "Error");
      }
    });

    // ========= Eventos =========
    document.getElementById("btnRefrescar").addEventListener("click", () => load(true));
    document.getElementById("btnBuscar").addEventListener("click", () => load(true));
    elView.addEventListener("change", () => load(true));
    elIncludeCancelled.addEventListener("change", () => load(true));
    elOnlyAssignedToday.addEventListener("change", () => load(true));
    elQ.addEventListener("keydown", (e) => { if (e.key === "Enter") load(true); });

    document.getElementById("btnNext").addEventListener("click", () => {
      if (state.nextOffset !== null) { state.offset = state.nextOffset; load(false); }
    });
    document.getElementById("btnPrev").addEventListener("click", () => {
      state.offset = Math.max(0, state.offset - state.limit);
      load(false);
    });

    // init
    load(true);
  </script>
</body>
</html>
