<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#A7B59E" />
    <title>Ventas vs Meta ‚Ä¢ HarujaGdl</title>

    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <!-- ‚úÖ CONFIG GLOBAL (PWA) -->
    <!-- /config.js -> window.HARUJA = { API_URL: ".../exec", API_KEY: "harujaTNpwa2025" } -->
    <script src="/config.js"></script>

    <style>
      :root {
        --fondo: #ffffff;
        --texto: #383234;
        --acento: #a7b59e;
        --beige: #faf6f1;
        --gris: #6b6b6b;
        --borde: #e9e4dc;
        --shadow: 0 10px 30px rgba(56, 50, 52, 0.10);
        --radius: 18px;
      }

      * { box-sizing: border-box; }

      body{
        margin:0;
        font-family:"Montserrat", system-ui, -apple-system, "Segoe UI", sans-serif;
        background: var(--beige);
        color: var(--texto);
      }

      .wrap{
        max-width: 980px;
        margin: 0 auto;
        padding: 26px 18px 70px;
        text-align: center;
      }

      .title{
        display:flex;
        align-items:center;
        justify-content:center;
        gap: 12px;
        margin-top: 8px;
      }

      .title .icon{
        width: 36px; height: 36px;
        display:flex; align-items:center; justify-content:center;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 6px 16px rgba(56,50,52,.10);
      }

      h1{
        margin:0;
        font-size: 34px;
        letter-spacing: .2px;
      }

      .sub{
        margin: 6px 0 22px;
        color: var(--gris);
        font-size: 14px;
      }

      .card{
        background:#fff;
        border: 1px solid var(--borde);
        box-shadow: var(--shadow);
        border-radius: 22px;
        padding: 18px 18px 16px;
        max-width: 860px;
        margin: 0 auto;
        text-align: left;
      }

      .legend{
        display:flex;
        justify-content: space-between;
        align-items:center;
        gap: 12px;
        margin-bottom: 10px;
        font-size: 13px;
        color: var(--gris);
      }
      .legend b{ color: var(--texto); }

      .rows{
        display:flex;
        flex-direction: column;
        gap: 10px;
        padding: 8px 0 2px;
      }

      .row{
        display:grid;
        grid-template-columns: 88px 1fr 120px;
        gap: 12px;
        align-items: center;
      }

      .label{
        font-size: 13px;
        color: var(--texto);
        opacity: .95;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .barwrap{
        position: relative;
        height: 14px;
        background: rgba(167, 181, 158, 0.22);
        border-radius: 999px;
        overflow: hidden;
      }

      .bar{
        height: 100%;
        width: 0%;
        background: var(--acento);
        border-radius: 999px;
        transition: width .35s ease;
      }

      .metaLine{
        position:absolute;
        top: -4px; bottom: -4px;
        width: 2px;
        background: rgba(56, 50, 52, 0.35);
        border-radius: 2px;
      }

      .value{
        text-align: right;
        font-size: 13px;
        color: var(--texto);
        white-space: nowrap;
      }

      .hint{
        margin-top: 10px;
        font-size: 12px;
        color: var(--gris);
        line-height: 1.35;
      }

      .actions{
        margin-top: 14px;
        display:flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .btn{
        width: min(520px, 100%);
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--acento);
        color:#fff;
        font-size: 14px;
        cursor:pointer;
      }
      .btn:disabled{ opacity:.7; cursor: default; }

      .link{
        display:inline-flex;
        gap: 8px;
        align-items: center;
        margin-top: 14px;
        color: var(--texto);
        text-decoration: underline;
        font-size: 14px;
      }

      /* Toast */
      .toast{
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: #383234;
        color: #fff;
        padding: 10px 16px;
        border-radius: 999px;
        font-size: .9rem;
        max-width: 92%;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,.25);
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity .25s ease, transform .25s ease;
      }
      .toast--visible{
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      .toast--error{ background:#b53737; }
      .toast--success{ background:#3a7f4a; }
      .toast--info{ background:#383234; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="title">
        <div class="icon">üìà</div>
        <div>
          <h1>Ventas vs Meta</h1>
          <div class="sub">Meta mensual: <b id="metaTxt">$10,000</b></div>
        </div>
      </div>

      <div class="card">
        <div class="legend">
          <span><b>Mes</b> / Ventas</span>
          <span id="status">Listo</span>
        </div>

        <div id="rows" class="rows"></div>

        <div class="hint">
          La l√≠nea vertical marca la meta mensual. El porcentaje es <b>Ventas / Meta</b>.
        </div>

        <div class="actions">
          <button id="btnReload" class="btn" type="button">Actualizar</button>
        </div>
      </div>

      <a class="link" href="/index.html">‚¨ÖÔ∏è Volver al panel</a>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ===================== CONFIG =====================
      const HARUJA_API_URL =
        (window.HARUJA && window.HARUJA.API_URL) ||
        "https://script.google.com/macros/s/AKfycbz51hV2sc5Ho_tBcaygWp1qfcLdeXgsQZ1m7aRV_6CHp80piwEoDfiuBSJXrSMoGFS4/exec";

      const HARUJA_API_KEY =
        (window.HARUJA && window.HARUJA.API_KEY) || "harujaTNpwa2025";

      // ‚úÖ Meta default (si tu hoja no trae meta o trae 0)
      const META_MENSUAL_DEFAULT = 10000;

      // ‚úÖ Acci√≥n REAL en tu TN_API_PWA.gs
      const ACTION = "dashboard_mensual";

      // ===================== UI HELPERS =====================
      const elRows = document.getElementById("rows");
      const elStatus = document.getElementById("status");
      const btnReload = document.getElementById("btnReload");
      const toastEl = document.getElementById("toast");

      let toastTimer = null;
      function showToast(msg, type="info"){
        toastEl.textContent = msg || "";
        toastEl.className = "toast toast--visible toast--" + type;
        if(toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toastEl.className = "toast";
        }, 3600);
      }

      function moneyMX(n){
        const x = Number(n) || 0;
        return x.toLocaleString("es-MX", { style: "currency", currency: "MXN" });
      }

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      function setMetaTxt(meta){
        const m = Number(meta) || META_MENSUAL_DEFAULT;
        document.getElementById("metaTxt").textContent =
          m.toLocaleString("es-MX", { style: "currency", currency: "MXN" });
      }

      // ===================== JSONP (Apps Script + Vercel) =====================
      function jsonp(url, timeoutMs = 15000) {
        return new Promise((resolve, reject) => {
          const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
          const sep = url.includes("?") ? "&" : "?";
          const fullUrl = url + sep + "callback=" + encodeURIComponent(cbName);

          let done = false;
          const script = document.createElement("script");

          const timer = setTimeout(() => {
            if (done) return;
            done = true;
            cleanup();
            reject(new Error("Timeout JSONP"));
          }, timeoutMs);

          function cleanup() {
            clearTimeout(timer);
            try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
            if (script && script.parentNode) script.parentNode.removeChild(script);
          }

          window[cbName] = (data) => {
            if (done) return;
            done = true;
            cleanup();
            resolve(data);
          };

          script.onerror = () => {
            if (done) return;
            done = true;
            cleanup();
            reject(new Error("Error cargando JSONP"));
          };

          script.src = fullUrl;
          document.body.appendChild(script);
        });
      }

      // ===================== RENDER =====================
      function renderMonthly(labels, ventas, metas){
        elRows.innerHTML = "";

        const n = Math.min(labels.length, ventas.length);
        if(!n){
          elStatus.textContent = "Sin datos";
          elRows.innerHTML = `<div style="color:var(--gris); font-size:13px; padding:8px 0;">No hay informaci√≥n para mostrar.</div>`;
          return;
        }

        // meta por fila si viene, si no -> default
        const metaByRow = Array.from({length:n}, (_, i) => {
          const m = Number((metas && metas[i] != null) ? metas[i] : 0) || 0;
          return m > 0 ? m : META_MENSUAL_DEFAULT;
        });

        // meta ‚Äúprincipal‚Äù para texto: usa la primera meta v√°lida o default
        const metaPrincipal = metaByRow.find(m => m > 0) || META_MENSUAL_DEFAULT;
        setMetaTxt(metaPrincipal);

        // escala: m√°ximo entre ventas y meta (y un colch√≥n)
        const maxVentas = Math.max(...ventas.slice(0,n).map(v => Number(v)||0), 0);
        const maxMeta = Math.max(...metaByRow, META_MENSUAL_DEFAULT);
        const scaleMax = Math.max(maxMeta * 1.5, maxVentas, META_MENSUAL_DEFAULT);

        // Render
        for(let i=0; i<n; i++){
          const mes = String(labels[i] ?? "").trim();
          const v = Number(ventas[i]) || 0;
          const meta = metaByRow[i];

          const pct = clamp((v / scaleMax) * 100, 0, 100);
          const metaPct = clamp((meta / scaleMax) * 100, 0, 100);
          const ratio = meta > 0 ? (v / meta) * 100 : NaN;
          const ratioTxt = isFinite(ratio) ? `${Math.round(ratio)}%` : "‚Äî";

          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div class="label" title="${mes}">${mes}</div>
            <div class="barwrap" aria-label="Barra de ventas">
              <div class="bar" style="width:${pct.toFixed(2)}%"></div>
              <div class="metaLine" style="left:${metaPct.toFixed(2)}%"></div>
            </div>
            <div class="value" title="${moneyMX(v)}">
              ${moneyMX(v)} ¬∑ ${ratioTxt}
            </div>
          `;
          elRows.appendChild(row);
        }

        // si todo viene en 0, dilo
        const sumVentas = ventas.slice(0,n).reduce((a,b)=>a+(Number(b)||0),0);
        elStatus.textContent = sumVentas > 0 ? "OK" : "Sin datos";
      }

      // ===================== FETCH DATA =====================
      async function cargar(){
        btnReload.disabled = true;
        elStatus.textContent = "Cargando‚Ä¶";

        try{
          const url =
            HARUJA_API_URL +
            "?action=" + encodeURIComponent(ACTION) +
            "&key=" + encodeURIComponent(HARUJA_API_KEY) +
            "&t=" + Date.now();

          const raw = await jsonp(url, 20000);

          console.log("üì¶ dashboard_mensual raw:", raw);

          if(!raw || raw.ok !== true){
            const errMsg = (raw && (raw.error || raw.message)) ? (raw.error || raw.message) : "No se pudo cargar la informaci√≥n.";
            elStatus.textContent = "Error";
            elRows.innerHTML = `<div style="color:var(--gris); font-size:13px; padding:8px 0;">No se pudo cargar la informaci√≥n.</div>`;
            showToast(errMsg, "error");
            return;
          }

          const labels = Array.isArray(raw.labels) ? raw.labels : [];
          const ventas = Array.isArray(raw.ventas) ? raw.ventas : [];
          const meta = Array.isArray(raw.meta) ? raw.meta : [];

          renderMonthly(labels, ventas, meta);
          showToast("Datos actualizados ‚úÖ", "success");
        }catch(err){
          console.error("‚ùå Error cargar Ventas vs Meta:", err);
          elStatus.textContent = "Error";
          elRows.innerHTML = `<div style="color:var(--gris); font-size:13px; padding:8px 0;">No se pudo cargar la informaci√≥n. Revisa consola.</div>`;
          showToast("No se pudo cargar la informaci√≥n. Revisa el endpoint.", "error");
        }finally{
          btnReload.disabled = false;
        }
      }

      // ===================== INIT =====================
      btnReload.addEventListener("click", cargar);
      document.addEventListener("DOMContentLoaded", cargar);

      // ‚úÖ Register Service Worker (PWA)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
          try {
            const reg = await navigator.serviceWorker.register("/service-worker.js", { scope: "/" });
            console.log("‚úÖ SW registrado:", reg.scope);
          } catch (err) {
            console.warn("‚ùå SW no se pudo registrar:", err);
          }
        });
      }
    </script>
  </body>
</html>
